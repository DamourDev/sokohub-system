{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="container mt-4 mb-5">

    {% if messages %}
        {% for message in messages %}
            <div class="alert alert-{{ message.tags }} alert-dismissible fade show shadow-sm" role="alert">
                {% if message.tags == 'success' %}
                    <i class="bi bi-check-circle-fill me-2"></i>
                {% elif message.tags == 'error' %}
                    <i class="bi bi-exclamation-triangle-fill me-2"></i>
                {% endif %}
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        {% endfor %}
    {% endif %}

    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="fw-bold text-dark">Vendor Dashboard</h2>
            <p class="text-muted mb-0">Welcome back, {{ request.user.username }}! Here is your daily overview.</p>
        </div>
        <a href="{% url 'add_product' %}" class="btn btn-primary px-4 py-2 shadow-sm fw-bold">
            <i class="bi bi-plus-lg me-2"></i>Add New Product
        </a>
    </div>

    <div class="row g-3 mb-5">
        <div class="col-md-3 col-sm-6">
            <div class="card border-0 shadow-sm h-100 border-start border-4 border-primary">
                <div class="card-body">
                    <h6 class="text-muted text-uppercase small fw-bold">Total Products</h6>
                    <h3 class="mb-0 display-6 fw-bold text-dark">{{ total_products }}</h3>
                </div>
            </div>
        </div>

        <div class="col-md-3 col-sm-6">
            <div class="card border-0 shadow-sm h-100 border-start border-4 border-success">
                <div class="card-body">
                    <h6 class="text-muted text-uppercase small fw-bold">Active</h6>
                    <h3 class="mb-0 display-6 fw-bold text-dark">{{ active_products }}</h3>
                </div>
            </div>
        </div>

        <div class="col-md-3 col-sm-6">
            <div class="card border-0 shadow-sm h-100 border-start border-4 border-danger">
                <div class="card-body">
                    <h6 class="text-muted text-uppercase small fw-bold">Out of Stock</h6>
                    <h3 class="mb-0 display-6 fw-bold text-dark">{{ out_of_stock_products }}</h3>
                </div>
            </div>
        </div>

        <div class="col-md-3 col-sm-6">
            <div class="card border-0 shadow-sm h-100 border-start border-4 border-warning">
                <div class="card-body">
                    <h6 class="text-muted text-uppercase small fw-bold">Pending Orders</h6>
                    <h3 class="mb-0 display-6 fw-bold text-dark">{{ pending_orders }}</h3>
                </div>
            </div>
        </div>
    </div>

    <div class="mb-4 d-flex gap-2">
        <a href="{% url 'vendor_products_list' %}" class="btn btn-outline-secondary">
            <i class="bi bi-list-ul me-2"></i>Manage All Products
        </a>
        <a href="{% url 'vendor_orders' %}" class="btn btn-outline-secondary">
            <i class="bi bi-receipt me-2"></i>Manage Orders
        </a>
    </div>

    <h4 class="mb-3 text-dark fw-bold">Recent Products</h4>
    <div class="row g-4">
        {% if recent_products %}
            {% for product in recent_products %}
                <div class="col-lg-3 col-md-4 col-sm-6">
                    <div class="card h-100 shadow-sm border-0 product-card">
                        <div class="position-relative">
                            {% comment %} {% if product.image %}
                                <img src="{{ product.image.url }}" class="card-img-top gallery-trigger" style="height: 200px; object-fit: cover;" alt="{{ product.name }}">
                            {% else %}
                                <div class="bg-light d-flex align-items-center justify-content-center" style="height: 200px;">
                                    <i class="bi bi-image text-muted fs-1"></i>
                                </div>
                            {% endif %} {% endcomment %}

                            {% if product.image %}
                                <img src="{{ product.image.url }}" 
                                    class="card-img-top gallery-trigger" 
                                    style="width:100%; height:200px; object-fit:cover; border-radius:6px; cursor: pointer;" 
                                    alt="{{ product.name }}"
                                    data-bs-toggle="modal" 
                                    data-bs-target="#galleryModal"
                                    data-main="{{ product.image.url }}"
                                    data-images="{% for g in product.gallery_images.all %}{{ g.image.url }},{% endfor %}">
                            {% else %}
                                <img src="{% static 'images/placeholder.png' %}" class="card-img-top" style="height:200px; object-fit:cover;" alt="No Image">
                            {% endif %}
                            
                            {% comment %} <div class="position-absolute top-0 end-0 m-2">
                                
                            </div> {% endcomment %}
                        </div>

                        <div class="card-body">
                            <h5 class="card-title text-truncate fw-bold mb-1">{{ product.name }}</h5>
                            
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span class="text-primary fw-bold">{{ product.price }} Frw</span>
                                {% comment %} <p class="small text-muted">
                                    Gallery Count: {{ product.gallery_images.count }}
                                </p> {% endcomment %}
                                {% if product.category %}
                                    <small class="text-muted">{{ product.category.name }}</small>
                                {% endif %}
                            </div>
                            {% if product.stock > 0 %}
                                    <span class="badge bg-success bg-opacity-75 backdrop-blur shadow-sm">In Stock</span>
                                {% else %}
                                    <span class="badge bg-danger shadow-sm">Out of Stock</span>
                                {% endif %}
                            
                            <div class="d-grid gap-2 d-flex justify-content-between mt-3 w-1/2">
                                <a href="{% url 'edit_product' product.id %}" class="btn btn-sm btn-outline-primary flex-grow-1">
                                    <i class="bi bi-pencil me-1"></i> Edit
                                </a>
                                
                                <button type="button" 
                                        class="btn btn-sm btn-outline-danger" 
                                        data-bs-toggle="modal" 
                                        data-bs-target="#deleteModal" 
                                        data-product-id="{{ product.id }}"
                                        data-product-name="{{ product.name }}">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            {% endfor %}
        {% else %}
            <div class="col-12 text-center py-5 bg-light rounded-3">
                <div class="text-muted mb-3"><i class="bi bi-box-seam display-1"></i></div>
                <h5>No products yet</h5>
                <p class="text-muted">Start building your store by adding your first item.</p>
                <a href="{% url 'add_product' %}" class="btn btn-primary">Add Product</a>
            </div>
        {% endif %}
    </div>
</div>

<div class="modal fade" id="deleteModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg">
            <div class="modal-header border-0 pb-0">
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center pt-0 pb-4">
                <div class="text-danger mb-3">
                    <i class="bi bi-trash3 display-1"></i>
                </div>
                <h4 class="fw-bold mb-2">Delete Product?</h4>
                <p class="text-muted mb-4">Are you sure you want to delete <strong id="modalProductName" class="text-dark">this item</strong>?<br>This action cannot be undone.</p>
                
                <div class="d-flex justify-content-center gap-3">
                    <button type="button" class="btn btn-light px-4" data-bs-dismiss="modal">Cancel</button>
                    
                    <form id="deleteForm" method="POST" action="">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-danger px-4 fw-bold">Yes, Delete</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="galleryModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content bg-transparent border-0 shadow-none">
        <div class="modal-body p-0 text-center position-relative">
            
            <button type="button" class="btn-close btn-close-white position-absolute top-0 end-0 m-3 z-3" data-bs-dismiss="modal"></button>

            <img id="modalMainImage" src="" class="img-fluid rounded shadow-lg mb-2" style="max-height: 500px; object-fit: contain; background: #fff;">

            <div id="modalGalleryStrip" class="d-flex justify-content-center gap-2 overflow-auto py-2"></div>

        </div>
    </div>
  </div>
</div>

<script>
    var deleteModal = document.getElementById('deleteModal')
    deleteModal.addEventListener('show.bs.modal', function (event) {
        var button = event.relatedTarget
        var productId = button.getAttribute('data-product-id')
        var productName = button.getAttribute('data-product-name')
        
        // Update Name
        var modalTitle = deleteModal.querySelector('#modalProductName')
        modalTitle.textContent = productName
        
        // Update Form Action URL
        var form = deleteModal.querySelector('#deleteForm')
        form.action = "/product/delete/" + productId + "/"
    });

    document.addEventListener('DOMContentLoaded', function() {
        var galleryModal = document.getElementById('galleryModal');
        var mainImage = document.getElementById('modalMainImage');
        var galleryStrip = document.getElementById('modalGalleryStrip');

        galleryModal.addEventListener('show.bs.modal', function (event) {
            // 1. Get data from the clicked image
            var trigger = event.relatedTarget;
            var mainSrc = trigger.getAttribute('data-main');
            var galleryData = trigger.getAttribute('data-images');
            
            // Set Main Image
            mainImage.src = mainSrc;
            galleryStrip.innerHTML = ''; 

            // Add Main Thumbnail
            addThumbnail(mainSrc, true);

            // Add Gallery Thumbnails
            if (galleryData) {
                var urls = galleryData.split(',');
                urls.forEach(function(url) {
                    if (url.trim() !== '') {
                        addThumbnail(url, false);
                    }
                });
            }
        });

        function addThumbnail(url, isActive) {
            var thumb = document.createElement('img');
            thumb.src = url;
            thumb.style.width = '60px'; 
            thumb.style.height = '60px'; 
            thumb.style.objectFit = 'cover';
            thumb.className = 'rounded border border-2 ' + (isActive ? 'border-primary' : 'border-white opacity-50');
            thumb.style.cursor = 'pointer';
            
            thumb.onclick = function() {
                mainImage.src = url; // Swap main image
                // Reset styles
                Array.from(galleryStrip.children).forEach(c => c.className = 'rounded border border-2 border-white opacity-50');
                thumb.className = 'rounded border border-2 border-primary'; // Highlight active
            };
            galleryStrip.appendChild(thumb);
        }
    });
</script>

{% endblock content %}